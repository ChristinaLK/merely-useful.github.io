# Reproducibility {#r-reproducibility}

## Questions

- How do I organize my data analysis projects?
- How can I make sure that my code is understandable to others?
- How do I ensure my analyses are reproducible by others (and myself 9 months in
the future)?

TODO: Add more

## Objectives 

1. To become aware of and learn some "best practices" (or "good enough
practices") for project organization.
1. To use RStudio to create and manage projects in a consistent and structured
way.
1. To become aware of the importance of reproducibility in data analyses, for
your own productivity and for greater rigor in science.
1. To create reproducible documents interwoven with R code that can be easily
updated by changing the code or data.

TODO: Briefly introduce functions here?

## Introduction

General outline:

-   How should I organize my projects?
    -   Noble's Rules
    -   RStudio projects
-   How can I make programs easy to re-use/self-contained?
    -   Taschuk's Rules
    - Absolute vs relative paths
-   How can I make programs easy to read?
    -   coding style
    -   linters
    -   documentation
-   How can I combine explanations, code, and results?
    -   notebooks
-   How should I keep track of my data?
    -   simple manifests
    - TODO: Not entirely sure what this part should cover
-   What *isn't* included?
    -   build tools (Make and its kin)
    -   continuous integration
    - documentation generators
    
### What is reproducibility and why try to do it?

There are several key cornerstones for doing rigorous and sound scientific
research, two of which are reproducibility and replicability. Replicability is
when a study is repeated by other independent research groups. Reproducibility
is when, given the same data and the same analytical/computational steps, a
scientific result can be verified. Both of these concepts are surprisingly
difficult to achieve.

This course is about data analysis, so we'll be focusing solely on reproducibility
rather than replicability. At present, there is little effort in science for
having research be reproducible, likely due in many ways to a lack of training
and awareness. Being reproducible isn't also just about doing better science, it
can also:

TODO: Add some reference here about definitions, lacking reproducibility, etc?

1. Make you much more efficient and productive, as you spend less time between
coding and putting your results in the document.
1. Make you more confident in your results, since what you report and show as
figures or tables will be exactly what you get from your analysis. No copying
and pasting required!

TODO: Add more items here.

There are many aspects to reproducibility, such as:

- Organized files and folder, preferably based on a standard or conventional structure.
- Understandable and readable code that is documented and descriptive.
- Results from analyses are identical to results presented in scientific output (e.g. article, poster, slides).
- Results from analyses are identical when code is executed on other machines (results aren't dependent on one computer).
- Explicit description or instruction on the order that code and scripts need to be executed.

We'll cover the first three items in this course.

## Project organization

TODO: refs to rrtools, prodigenr, and the top rules article.

The ability to read, understand, modify, and write simple pieces of code is an
essential skill for modern data analysis tasks and projects. Here we introduce
you to some of the best practices one should have while writing their code.
Many of these best practices were taken from published "best practices" articles.

TODO: Include references to best practices articles here.

- Organise all R scripts and files in a single parent directory using a common
and consistent folder and file structure.
- Use [version control][version-control] to track changes to files.
- Make raw data "read-only" (don't edit it directly) and use code to show what
was done.
- Write and describe code for people to read by being descriptive and using a
[style guide][r-style-guide].
- Think of code as part of your research product: Write for an audience 
or other reader.
- Don't repeat yourself by using and creating functions.
- Whenever possible, use code to create output (figures, tables) rather than
manualling creating or editing them.

Managing your projects in a reproducible fashion doesn't just make your science
reproducible, it also makes your life easier! RStudio is here to help us with
that by using [R Projects][rstudio-r-projects]. RStudio projects make it
straightforward to divide your work into multiple contexts, each with their own
working directory, workspace, history, and source documents.

It is strongly recommended that you store *all* the necessary files that will be
used in your code in the **same parent directory**. You can then use
relative file paths to access them (we'll talk about file paths below). This
makes the directory and R Project a "product" or "bundle/package". Like a tiny
machine, that needs to have all its parts in the same place.

### Creating your first project

There are many ways one could organise a project folder. We'll set up a project
directory folder using the
[prodigenr](http://prodigenr.lukewjohnston.com) package:

```r
# prodigenr::setup_project("ProjectName")
prodigenr::setup_project("learningr")
```

TODO: Use prodigenr or something else?

When we use the `::` colon here, we are telling R "from the prodigenr package use
the setup_project function". This function will then create the following
folders and files:

```
learningr
├── R
│   ├── README.md
│   ├── fetch_data.R
│   └── setup.R
├── data
│   └── README.md
├── doc
│   └── README.md
├── .Rbuildignore
├── .gitignore
├── DESCRIPTION
├── learningr.Rproj
└── README.md
```

This forces a specific, and consistent, folder structure to all your work. Think 
of this like the "introduction", "methods", "results", and "discussion" sections 
of your paper. Each project is then like a single manuscript or report, that
contains everything relevant to that specific project. There is a lot of
power in something as simple as a consistent structure. Projects are used to
make life easier. Once a project is opened within RStudio the following actions
are taken:

- A new R session (process) is started.
- The current working directory is set to the project directory.
- RStudio project options are loaded.

The README in each folder explains a bit about what should be placed there. But
briefly:

1. Documents like manuscripts, abstracts, and exploration type documents should 
be put in the `doc/` directory (including [R Markdown] files which we will cover
[later](/course/reproducible-documents/)).
1. Data, raw data, and metadata should be in either the `data/` directory or
in `data-raw/` for the raw data.
1. All R files and code should be in the `R/` directory.
1. Name all new files to reflect their content or function. Follow the tidyverse 
[style guide for file naming](https://style.tidyverse.org/files.html).

[R Markdown]: https://rmarkdown.rstudio.com/

For the course, we'll delete all files except for the `R/`, `data/`, and `doc/`
folders as well as the `learning-r.Rproj` and `.gitignore` file. For any
project, it is **highly recommended** to use [version control]. We'll be
covering version control in more detail [later](/courses/version-control/) in
the course.

### Exercise: Better file naming

Look at the list of file names below. Which file names are good names and which
shouldn't you use? 

```
fit models.R
fit-models.R
foo.r
stuff.r
get_data.R
Manuscript version 10.docx
manuscript.docx
new version of analysis.R
trying.something.here.R
plotting-regression.R
utility_functions.R
code.R
```

### Next steps after creating the project

Now that we've created a project and associated folders, let's add some more
options to the project. One option to set is to ensure that every R session you 
start is a "blank slate", by typing and running in the Console:

```r
usethis::use_blank_slate()
```

TODO: Add more about this, e.g. `.RData`

### Packages, data, and file paths

FIXME: This section may be more appropriate earlier.

A major strength of R is in its ability for others to easily create packages
that simplify doing complex tasks (e.g. running mixed effects models with the
[lme4][lme4] package or creating figures with the [ggplot2][ggplot2] package)
and for anyone to easily install and use that package. You may encounter some
who say you shouldn't rely on packages and only use base R functions. However, 
this is seriously bad advice since the ecosystem of R packages can greatly 
simplify your life doing data analysis. Plus, packages greatly expand and enhance
the capability of R, so make use of packages!

You load a package by writing:

```r
library(tidyverse)
```

Working with multiple R scripts and files, it quickly gets tedious to always
write out each library function at the top of each script. A better way of
managing this is to create a new file, keep all package loading code in that
file, and sourcing that file in each R script. So:

```r
usethis::use_r("package-loading")
```

In the `package-loading.R` file:

```r
library(tidyverse)
```

In any other `.R` file:

```r
source(here::here("R/package-loading.R"))
```

There's a new thing `here`! The [here] package uses a function called `here()` 
that makes it easier to manage file paths. What is a file path and why is this 
necessary? A file path is the list of folders a file is found in. For instance,
your CV may be found in `/Users/Documents/personal_things/CV.docx`. The problem 
with file paths in R is that when you run a script interactively (e.g. what we
do in class and normally), the file path is located at the Project level (where 
the `.Rproj` file is found). You can see the file path by looking at the top of
the "Console". But! When you `source()` an R script, it may likely run *in the
folder it is saved in*, e.g. in the `R/` folder. So your file path
`R/packages-loading.R` won't work because there isn't a folder called R in the
`R/` folder. Often people use the function `setwd()`, but this is *never* a good
idea since using it makes your script *runnable only on your computer*... which
makes it no longer reproducible. We use the `here()` function to tell R to go
to the project root (where the `.Rproj` file is found) and then use that file
path. This simple function can make your work more reproducible and easier for
you to use later on.

[here]: https://here.r-lib.org/

We also use the `here()` function when we import a dataset. Let's save a dataset
as a [csv] file. In the `project-session.R` file, add this to the top of the file:

[csv]: https://en.wikipedia.org/wiki/Comma-separated_values

```{r, eval=FALSE}
source(here::here("R/package-loading.R"))
```

Then, let's add these lines to the end of the file:

```{r, eval=FALSE}
write_csv(iris, here::here("data/iris.csv"))
imported_iris <- read_csv(here::here("data/iris.csv"))
head(imported_iris)
```


## Reusability

here::here

https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005412

### DRY and describing your code

DRY or "don't repeat yourself" is another way of saying, "make your own
functions"! That way you don't need to copy and paste code you've used multiple
times. Using functions also can make your code more readable and descriptive,
since a function is a bundle of code that does a specific task... and usually
the function name should describe what you are doing. We'll be covering functions
more in the [Efficient Coding](/course/efficient-coding/) section of the course,
but we'll talk about it briefly here. 

What does a "function" mean? A function is, as mentioned, a bundled sequence of
code that does a specific thing. Imagine it as a machine, like a microwave or
oven. Each has a bunch of parts that work together to do something (e.g. cook
food). Same with functions. And like machines, you can look at the contents of
functions, like so:

```{r}
# Inside standard deviation function
sd
```

It is very important for your future self, and for any person that will be
reading/using your code to be able to understand what the code *does* and what
it will *create* (or output). So it's crucial to describe what the code does
through code comments, documentation, and descriptive naming of the function and
other objects. For instance, if your function name is decriptive, then you don't
need to spend much time describing what the code does and remember how to use
it. Also, use code comment (anything after a `#`) to provide more detailed
explanations of your code if the code is complicated or long (these of course are
a bit subjective).

Example:

```{r}
# The following function outputs the sum of two numeric objects (a and b). 
# usage: summing(a = 2, b = 3)
summing <- function(a, b) {
    return(a + b)
}

summing(a = 2, b = 3)
```

The example above is summing up two different numeric objects. Note that the
name for this function was chosen as **summing**, instead of **sum**. This is
because R already has a built-in function called **sum** and so we don't want to
overwrite it! We'll go over more of writing functions in the [Efficient
Coding](/course/efficient-coding/) section.

## Readability

There are two reasons we write code: to instruct the computer to do something and
to record the steps we took to get a particular result for us or others to
understand. For computers, *how* or *what* you write doesn't matter, as long as
the code is correct. But for humans, we need clear language in order to understand
what is going on. Humans write code, humans read code, and humans must maintain them
and fix any errors. So, what you write and how you write it is extremely important.

Like natural human languages, R has a relaxed approached to how R code is written.
This has some nice advantages, but also some major disadvantages, notably that
writing styles can be quite different across the world or even within one's own
code. So, it's important to stick to some guidelines, for instance, as laid out
by the tidyverse [style guide][r-style-guide].

Some tips to use when working in R:

- Think of writing code as if you are writing in a natural language like English.
- Imagine that other people will be reading your code.
- Keep the code clear, simple, and *readable*.
- Stick to a *[style guide][r-style-guide]*.
- Use full and descriptive words when typing and creating objects.
- Use white space to separate concepts (empty lines between them, use spaces, and/or tabs).
- Use RStudio R Script Sections (`"Code->Insert Section"` or `Ctrl-Shift-R`) to
separate content in scripts.

Even though R doesn't care about naming, spacing, and indenting, it really
matters how your code looks. Coding is just like writing. Even though you may go
through a brainstorming note-taking stage of writing, you eventually need to
write correctly so others can understand, *and read*, what you are trying to
say. Brainstorming and exploratory work is fine, but eventually you need to
write code that will be legible. That's why using a [style guide][r-style-guide]
is really important.

### Exercise: Make the code more readable

Using the [style guide][r-style-guide] found in the link, try to make these code
more readable. The code below is in some way either *wrong* or incorrectly
written. Edit the code so it follows the correct style and so it is easier to
understand and read. You don't need to understand what the code does, just
follow the guide.

```{r r-repro-exercise-readable-code, eval=FALSE}
# Object names
DayOne
dayone
T <- FALSE
c <- 9
mean <- function(x) sum(x)

# Spacing
x[,1]
x[ ,1]
x[ , 1]
mean (x, na.rm = TRUE)
mean( x, na.rm = TRUE )
function (x) {}
function(x){}
height<-feet*12+inches
mean(x, na.rm=10)
sqrt(x ^ 2 + y ^ 2)
df $ z
x <- 1 : 10

# Indenting
if (y < 0 && debug)
message("Y is negative")
```

FIXME: The below "details" will need to be dealt with since PDF doesn't allow this
TODO: Maybe move to a solutions section at the end of chapter?

<details><summary><strong>Click for a possible solution</strong></summary>
<p>

The old code is in comments and the better code is below it.

```{r r-repro-exercise-readable-code-solution, eval=FALSE}
# Object names

# Should be camel case
# DayOne
day_one
# dayone
day_one

# Should not over write existing function names
# T = TRUE, so don't name anything T
# T <- FALSE
false <- FALSE
# c is a function name already. Plus c is not descriptive
# c <- 9
number_value <- 9
# mean is a function, plus does not describe the function which is sum
# mean <- function(x) sum(x)
sum_vector <- function(x) sum(x)

# Spacing
# Commas should be in correct place
# x[,1]
# x[ ,1]
# x[ , 1]
x[, 1]
# Spaces should be in correct place
# mean (x, na.rm = TRUE)
# mean( x, na.rm = TRUE )
mean(x, na.rm = TRUE)
# function (x) {}
# function(x){}
function(x) {}
# height<-feet*12+inches
height <- feet * 12 + inches
# mean(x, na.rm=10)
mean(x, na.rm = 10)
# sqrt(x ^ 2 + y ^ 2)
sqrt(x^2 + y^2)
# df $ z
df$z
# x <- 1 : 10
x <- 1:10

# Indenting should be done after if, for, else functions
# if (y < 0 && debug)
# message("Y is negative")
if (y < 0 && debug)
    message("Y is negative")
```

</p>
</details>

### Automatic styling with styler

You may have organised the exercise by hand, but it's possible to do it
automatically. The tidyverse [style guide][r-style-guide] has been implemented
into the [styler][styler-pkg] package to automate the process of following the
guide by directly re-styling selected code. The styler snippets can be found in
the Addins function in the RStudio "Addins" menu after you have installed it.

RStudio also has its own automatic styling ability, through the menu item `"Code ->
Reformat Code"` (or `Ctrl-Shift-A`). Try both methods of styling on the exercise
code above. There are slight differences in how each method works and they both
aren't always perfect. For now, let's stick with using the styler package. The
styler functions work on R code within both `.R` script files as well as R code
within `.Rmd` documents, which we will cover later in this lesson.

There are several styler RStudio addins, but we'll focus on the two:

- `"Style selection"`: Highlight text and click this button to reformat the code.
- `"Style active file"`: Code in the `.R` or `.Rmd` file you have open and
visible in RStudio will be reformatted when you click this button.

There are two other styler functions that are also useful:

- `styler::style_file("path/to/filename")`: Styles the whole file as indicated by the
file path in the first argument. Can be either an `.R` or `.Rmd` file.
- `styler::style_dir("directoryname")`: Styles all files in the indicated directory
in the first argument.

Let's try the `styler::style_file()` function out. Inside a file called
`non-styled-code.R`, it has:

```{r r-repro-non-styled-code, eval=FALSE}
# Spacing
x[,1]
mean (x, na.rm = TRUE)
function (x) {}
height<-feet*12+inches
sqrt(x ^ 2 + y ^ 2)
df $ z
x <- 1 : 10

# Indenting
if (y < 0 && debug)
message("Y is negative")
```

Then we run:

```{r r-repro-use-styler-file, eval=FALSE}
styler::style_file("testing-styler.R")
```

```
Styling  1  files:
 testing-styler.R ℹ 
────────────────────────────────────────
Status	Count	Legend 
✔ 	0	File unchanged.
ℹ 	1	File changed.
✖ 	0	Styling threw an error.
────────────────────────────────────────
Please review the changes carefully!
```

Which changes the file to be styled!

```{r r-repro-styled-code, eval=FALSE}
# Spacing
x[, 1]
mean(x, na.rm = TRUE)
function(x) {}
height <- feet * 12 + inches
sqrt(x^2 + y^2)
df$ z
x <- 1:10

# Indenting
if (y < 0 && debug) {
  message("Y is negative")
}
```

This is more or less everything that the styler package does.

### Exercise: Use styler to fix code formatting

Use the styler package function on the code from the previous exercise by either
running `styler::style_file()` or with the `"Style selection"` addin when
highlighting the code.

## To organize later

Here are a few tips for being efficient. Also check out the resources at the 
bottom for more places to learn about being efficient.

- Aggressively keep your code as simple and concise as you can. The less code
you have to write, debug, and maintain, the better. If you repeat code, stop and
think how to not repeat it. You will save time in the end by taking time to think
and plan.
- Try to always think in terms of wrangling data as data.frames. There is a lot
of power and utility from structure most things as data.frames. (e.g. "how can I
get the dataframe to the form I need to make a figure?")
- Keep learning. Keep reading books and help documentation. Keep taking courses
and workshops. And start teaching R to others! *hint hint* :wink: Seriously, it's
a great way for you to learn as it challenges you to know what you are talking 
about and teaching!
- When encountering a difficult problem, think about how to solve it, then try
to find R packages or functions that do your problem for you. You may hear some
poeple say "oh, don't bother with R packages, do everything in base R"... don't 
listen to them. Do you build a computer from scratch everytime you want to do
any type of work? Or a car when you want to drive somewhere? No, you don't. Make
use of other people's hard work to make tools that simplify your life.
- Use a [style guide] and create descriptive object names. Follow the [principles of tidy tools]
when creating functions and code.
- Split up your analyses steps into individual files (e.g. "model" file, "plot"
file). Then `source` those files as needed or save the output in `data/` to use 
it in other files.
- Try not to have R scripts be too long (e.g. more than 500 lines of code). Keep
script sizes as small as necessary and as specific as possible (have a single purpose).
A script should have an end goal.

## Integrating text, code, and results

The most obvious demonstration of reproducibility is when the results obtained
from executing the analysis code (by an independent entity) are indentical to
the results presented in the scientific output such as in an article. When there
is agreement between these two, reproducibility has been more or less acheived.
In R, there are tools available to *completely* ensure that this happens by
directly inserting the results from the code *into the scientific ouput*. This is
done by using [R Markdown][r-markdown], which interweaves R code with text.
So instead of, for example, manually inserting a figure, you write R code within
the document to insert the figure for you! Using [R Markdown][r-markdown] can
save so much time and get your work that much closer to being reproducible.

There are many other advantages to using R Markdown. From the single R Markdown
format you can use it to create manuscripts, posters, slides, websites, books,
and many more from simply using R Markdown! In fact, this book was written using
R Markdown! As a bonus, switching between citation formats or Word templates for
different journals is easier than doing it with Word.

### Markdown

R Markdown uses, well, [Markdown][markdown] as the format to convert to multiple
document types. Fun fact: This website is built based on Markdown! While there
are many "flavours" of Markdown that have been developed over the years, R
Markdown uses the [Pandoc][pandoc-markdown] version. Pandoc is a combination of
pan which is Latin for "all" and doc which means document.

Markdown is a "markup language" (like HTML, but simpler) meaning that special
characters mean certain things, which we will cover below. 

To format text, such as to bold or make a list, you use the special characters.
You write Markdown as plain text (like R code), so you don't need any special
software (like you do with Word documents). Most features needed for writing a
scientific document are available in Markdown, but not all. *Tip*: Try to fit
your writing and document creation around what Markdown can acheive, rather
than force or fight Markdown to do something it wasn't designed to do.

Alright, let's create and save an R Markdown file. In RStudio, go to `File ->
New File -> R Markdown`. A dialog box will pop up. In the "Title" section,
type in `Reproducible documents` and in the "Author" section type in your name.
Choose the HTML output format. Save this file as `learning-rmarkdown.Rmd` in the
`doc/` folder. 

Inside the file, there is a bunch of text that shows some basic formatting you
can use for writing Markdown. For now, delete everything *except* the top part
of the file (the part surrounded by `---`). This part is called the YAML header,
which we will cover more a bit later. Try converting the file to HTML by hitting
the "Knit" button at the top or by typing out `Ctrl-Shift-K`.

!["Knit" button.](figures/r-reproducibility/knit-button-rstudio.png)

#### Headers 

Creating headers (like chapters or sections) is indicated by using one or more `#`
at the beginning of a line, prefixing some text: 

```markdown
# Header level 1

Paragraph.

## Header level 2

Paragraph.

### Header level 3

Paragraph.
```

This creates the section headers as seen directly above ("Headers") or below
("Text formatting"). The header text *must* be on one line, otherwise the next
line is interpreted as paragraph text.

#### Text formatting

To format text individually, surround the text with the special characters, as
shown here:

- `**bold**` gives **bold**. 
- `*italics*` gives *italics*.
- `super^script^` gives super^script^.
- `sub~script~` gives sub~script~.

What if you want to use the special character as simple text? Prefix it with an `\`,
so `\*` becomes \*, `\^` becomes \^, and `\~` becomes \~.

#### Lists

To create an unnumbered list, do:

```markdown

- item 1
- item 2
- item 3

```

which gives...

- item 1
- item 2
- item 3

Notice the empty lines above and below the line, those are important. To create
a numbered list, do:

```markdown

1. item 1
2. item 2
3. item 3

```

which gives...

1. item 1
2. item 2
3. item 3

#### Blockquotes

Sometimes (probably not too commonly), you may need to quote someone by using 
"blockquotes". To do that, do:

```markdown
> Blockquote 
```

which gives...

> Blockquote 

Blockquotes can be as many lines as you want. To stop a paragraph from being in 
the blockquote, separate the text with an empty line:

```markdown
> Bockquote paragraph

Regular paragraph
```

#### Adding footnotes

Footnotes can be added by using `[^some-text-label]`, such as:

```markdown
Footnote[^1]

[^1]: Footnote content.
```

which gives...

Footnote[^1]

[^1]: Footnote content.

So you can write some text, add some footnotes within, and include the footnote 
content right below the paragraph:

```markdown
Paragraph text[^1], with some more text[^reference].

[^1]: This is the first footnote.
[^reference]: This is the next footnote.

More paragraphs.
```

Notice the empty lines in between. The footnote should also be on one line, though
it isn't strictly necessary.

#### Inserting pictures, images, or figures

You can include externally created (i.e. not by an R code chunk, discussed later
on) png, jpeg, or pdf image file by adding (:

```markdown
![Image caption here.](path/to/image/file.png)
```

So something like this:

```markdown
![Steps to being more reproducible. Source DOI: 10.1038/d41586-018-05990-5](figures/r-reproducibility/code-sharing-steps.png)
```

which gives...

![Steps to being more reproducible. Source DOI: [10.1038/d41586-018-05990-5](https://doi.org/10.1038/d41586-018-05990-5)](figures/r-reproducibility/code-sharing-steps.png)

*Tip*: Can also include links to images from the Internet, as a URL link.

If you want to modify the width or sizing, append something like `{width=##%}` to 
the end of the image insertion:

```markdown
![Caption.](figures/r-reproducibility/code-sharing-steps.png){width=50%}
```

which gives...

![Caption.](figures/r-reproducibility/code-sharing-steps.png){width=50%}

#### Adding links to websites

And a link can be linked in the following format:

```markdown
[Link to GitHub](https://github.com).
```

gives...

[Link to GitHub](https://github.com).

The above form is great for one time use, but what if you want to use the same link
again later on? Use this form then:

```markdown
Use multiple [links] in your document. The same [links] can be used again.

[links]: https://github.com
```

which gives...

Use multiple [links] in your document. The same [links] can be used again.

[links]: https://github.com

#### Inserting (simple) tables

You can insert tables with Markdown too. We wouldn't recommend doing it for 
complicated tables though, as it can get tedious fast! (A recommended approach
for more complex or bigger tables is to make the table contents as a data frame
in R first and then use the `knitr::kable()` function to create the table, as
we'll cover in the R Markdown section below). You can even include Markdown
text formatting inside the table:

```markdown
|   | Fun | Serious |
|:--|--:|:--:|
| **Happy** | 1234 | 5678 |
| **Sad** | 123 | 456 |
```

which gives...

|   | Fun | Serious |
|:--|--:|:--:|
| **Happy** | 1234 | 5678 |
| **Sad** | 123 | 456 |

The `|--:|` or `|:--|` tell the table to right-align or left-align,
respectively, the values in the table column. Center-align is `|:--:|`.

#### Exercise: Try to re-create a document using Markdown

TODO: Create a html page for them to try to mimic and re-create?

### R Markdown

[R Markdown][r-markdown] is an extension of Markdown that weaves together R code
with Markdown formatted text all together in a single document. Output from the
R code gets inserted directly into the document for a seamless integration of
document writing and analysis reporting.

#### YAML header/metadata

Most Markdown documents (especially for R Markdown) include [YAML][yaml] metadata at
the top of the document, surrounded by `---` on the top and bottom. The YAML
contains the metadata and various options for the entire document. For instance,
the title or author but also the output format you want to use, such as Word,
HTML, or PDF (if you want to create a beautiful PDF, you need to install the R
package [tinytex][tinytex]). There are many more output formats, but these are
the most common.

```yaml
---
title: "Document title"
author: Your Name
output: word_document
---
```

There are additional options you can set in the output field, which we will show
later below.

#### Now the best part! Inserting R code

One of the most powerful and useful features of R Markdown is its ability to
combine text and R code in the same document! You can insert plots by including a
code chunk, like the one below. The options added to the code chunk tell it to
add a caption, to set the height and width of the figure, and to prevent the code
chunk from showing up in the final document (`echo=FALSE`). The `bmi-plot` label is
the name of the code chunk (which you can see in the "Document Outline", found
using `Ctrl-Shift-O`, if you have the options set in the `Tools -> Global
Options -> R Markdown`).

**NOTE**: Code [chunk labels] should be named without `_`, spaces, or `.` and 
instead should be one word or be separated by `-`. While an error may not 
necessarily occur, there can be some unintended side effects that will cause you
some annoyance without knowing the reason.

[chunk labels]: https://yihui.name/knitr/options/#chunk-options

````markdown
`r ''````{r bmi-plot, fig.cap="Add your figure title here.", fig.height=8, fig.width=8, echo=FALSE}
ggplot(NHANES, aes(x = Height, fill = Gender)) +
    geom_density(alpha = 0.4) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_minimal() +
    theme(legend.position = c(0.2, 0.85))
`r ''````
````

(ref:insert-plot) Add your figure title here.

```{r bmi-plot, fig.cap="(ref:insert-plot)", fig.height=8, fig.width=8, echo=FALSE, eval=FALSE}
ggplot(NHANES, aes(x = Height, fill = Gender)) +
    geom_density(alpha = 0.4) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_minimal() +
    theme(legend.position = c(0.2, 0.85))
```

You can also create tables by using the `kable()` function from the knitr package:

````markdown
`r ''````{r mean-bmi-table, echo=FALSE}
library(knitr)
NHANES %>% 
    select(SurveyYr, BMI, Diabetes) %>% 
    group_by(SurveyYr, Diabetes) %>% 
    summarise(MeanBMI = mean(BMI, na.rm = TRUE)) %>% 
    spread(SurveyYr, MeanBMI) %>% 
    kable(caption = "Table caption here")
`r ''````
````

```{r mean-bmi-table, echo=FALSE, eval=FALSE}
library(knitr)
NHANES %>% 
    select(SurveyYr, BMI, Diabetes) %>% 
    mutate_at(vars(Diabetes), forcats::fct_explicit_na) %>% 
    group_by(SurveyYr, Diabetes) %>% 
    summarise(MeanBMI = round(mean(BMI, na.rm = TRUE), 2)) %>% 
    spread(SurveyYr, MeanBMI) %>% 
    kable(caption = "Table caption here")
```

Or just print out a number to the document:

````markdown
`r ''````{r, echo=FALSE}
cor(NHANES$Height, NHANES$Weight)
`r ''````
````

```{r, echo=FALSE}
cor(iris$Sepal.Length, iris$Sepal.Width)
```

#### Inline R code

You can also include R code within the text. You can use this to directly insert
numbers into the text of the document. By using something like:

> The mean of BMI is &#96;r round(mean(NHANES$BMI, na.rm = TRUE), 2)&#96;.

Gives...

The mean of BMI is ` round(mean(NHANES$BMI, na.rm = TRUE), 2)`.

*Note*: Inline R code can *only* insert a single number or character value,
nothing more.


#### Citing literature with R Markdown

If you want to insert a citation use `[@Cone2016]`, which will look like
[@Cone2016], with the resulting citation reference being inserted at the bottom
of the document. To get the bibliography to work, you'll need to add a line to
the YAML header like this:

```yaml
---
title: "My report"
author: "Me!"
bibliography: my_references.bib
---
```

Since all references are appended to the bottom of the document, make sure to
add a final "Reference" section header to the end of your file:

```markdown
# References
```

#### Making your report prettier

This part mostly applies to HTML-based and PDF[^tinytex] outputs, since
programmatically modifying or setting templates Word documents is rather
difficult[^md-to-word]. Changing broad features of a document can be done by setting the
"theme" of the document. Add an option in the YAML metadata like:

```yaml
---
title: "My report"
output:
    html_document:
        theme: sandstone
---
```

Check out the R Markdown [documentation] for more types of themes you can use
for HTML documents, and advanced topics such as parameterized R Markdown documents. 
Most of the [Bootswatch] themes are available for use in R
Markdown to HTML conversion.

[documentation]: https://bookdown.org/yihui/rmarkdown/html-document.html#appearance-and-style
[Bootswatch]: https://bootswatch.com/3/

[^tinytex]: Knitting to PDF will require that you install LaTeX using the [tinytex](https://yihui.name/tinytex/r/) R package. After you install LaTeX you can create truly beautifully typeset PDF documents.

[^md-to-word]: If you really want to do it, the best way is to create your template in the `.odt`, and then convert to `.docx`. [Here](https://github.com/andrewheiss/Global-Pandoc-files) is a good place to start. 

#### Exercise: Starting creating a report

Time: Until the end of the session.

Open RStudio and create an `R Markdown` document:

**File -> New File -> R Markdown**

Save the file in `doc/` and name the file `report.Rmd`. In the R Markdown
document, include the following "Header 1" `#` sections:

- Abstract
- Introduction
- Material and Methods
- Results
- Discussion
- Conclusion

(You don't have to actually fill these out for the assignment.) Compile it by
pressing the icon `Knit to HTML` or by typing `Ctrl-Shift-K`. Then:

- Write some random words below the **Abstract section**, while using bold and
italics.
- Include an unnumbered list below **Introduction** listing two or three fake
objectives.
- Include a "Header 2" (`##`) called "Statistical analysis" below "Material and
Methods".

Compile ("knit") the document again and see what happens. Then, add these
additional features to the document:

1. Include a random picture with caption (of your research or of any png you
find in your PC).
2. Include a footnote.
3. Include the link of your GitHub (if you created one) or of your academic profile.

Then, add some R code chunks with code to wrangle your data and also to create a
figure (you can copy and paste from previous sessions). Include these code chunks
in the "Results" section. 


## Additional learning resources and material

FIXME: Move this stuff to be included throughout, rather than at end?

**For learning**:

- [Good enough practicies in scientific computing](https://doi.org/10.1371/journal.pcbi.1005510) article
- [Best practices in scientific computing](https://doi.org/10.1371/journal.pbio.1001745) article
- [Organizing R Source Code](https://www.r-bloggers.com/r-best-practices-r-you-writing-the-r-way/)
- [An example of a well organised folder project](https://github.com/hadley/data-baby-names)
- [RStudio tutorial on using R Markdown](https://rmarkdown.rstudio.com/lesson-1.html)
- [Markdown syntax guide](https://rmarkdown.rstudio.com/authoring_basics.html)
- [Online book for R Markdown](https://bookdown.org/yihui/rmarkdown/)
- [Pandoc Markdown Manual](https://pandoc.org/MANUAL.html#pandocs-markdown) (R
Markdown uses [pandoc])
- [R for Data Science](http://r4ds.had.co.nz/)
    - [R Markdown chapter](https://r4ds.had.co.nz/r-markdown.html#r-markdown)

https://emilyriederer.netlify.com/post/rmarkdown-driven-development/

**For help**:

- [RStudio helpful cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
- [R Markdown cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown-2.0.pdf) (downloads a pdf file)
- [R Markdown reference cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf)
- [RStudio support](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects)
- [Tidyverse style guide](https://style.tidyverse.org/)

## Acknowledgements

Source material modified from https://rqawr-course.lwjohnst.com/ and many others
https://rqawr-course.lwjohnst.com/license/
